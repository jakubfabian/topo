{% extends "base.html" %}

{% block title %} 
  Mitopo.de - Route Edit Page
{% endblock %}

{% block extra_assets %}
  <style>
    .leaflet-container {  /* all maps */
    width:  100%;
    height: 512px;
    }
    .leaflet-draw-toolbar .leaflet-draw-draw-rectangle { display: none; background-position: -62px -2px; }
    .leaflet-draw-toolbar .leaflet-draw-draw-polygon {	display: none; }
    .leaflet-draw-toolbar .leaflet-draw-draw-circle { display: none; }
    .leaflet-draw-toolbar .leaflet-draw-draw-marker { display: none; }
    .leaflet-draw-toolbar .leaflet-draw-edit-remove {	display: none; }
    .leaflet-draw-actions a { display: none; }
  </style>

  {% load leaflet_tags %}
  {% load geojson_tags %}
  {% leaflet_js %}
  {% leaflet_css %}
  {% leaflet_js plugins="forms" %}
  {% leaflet_css plugins="forms" %}
{% endblock %} 

{% block content %} 

    <a href="/miroutes/"> Home </a> : <a href=../../../> {{ wall.wall_spot.spot_area.area_country.country_name }} </a> :: <a href="../../" >{{ wall.wall_spot.spot_area.area_name }} </a> :: <a href="../"> {{ wall.wall_spot.spot_name }} </a> :: <a href="../"> {{ wall.wall_name }} </a> :: {{ routegeom_selected.route.route_name }}
    <br><br>

    You're looking at wall {{ wall.wall_name }}
    <br><br>

<script type="text/javascript">
    var geodjango_geom = {};
    geodjango_geom.fieldid = 'id_geom';
    geodjango_geom.modifiable = true;
    geodjango_geom.geom_type = 'Geometry';
    geodjango_geom.srid = 4326;

    function id_geom_map_callback(map, options) {
        geodjango_geom.store_class = L.FieldStore;
        (new L.GeometryField(geodjango_geom)).addTo(map);
    };
</script>

<div id="id_geom_map" class="leaflet-container-default"></div>

<script type="text/javascript">
    (function () {

    function loadmap() {

        var img_dim_string = '{{ wall.wall_image.get_bg_img_size }}';

        var img_dim   = img_dim_string.split(',', 4);
        var img_dim_x = parseFloat(img_dim[0]);
        var img_dim_y = parseFloat(img_dim[1]);
        var xzoom     = parseFloat(img_dim[2]);
        var yzoom     = parseFloat(img_dim[3]);

        var maxzoom   = Math.max(xzoom, yzoom);

        // we choose a default zoom level of 2 that matches either the width (approx.) or the
        // height of the container
        var minzoom   = 2;
        var startzoom = minzoom;

        var aspectRatio = img_dim_x/img_dim_y;
        if (aspectRatio < 1){
            // we resize the container to fit an image with aspectRatio < 1
            // the height is then fixed to 1024px              
            var wall_width = 1024*aspectRatio;              
            // document.getElementById('wallmap').setAttribute("style","display:block;width:500px");
            document.getElementById('id_geom_map').style.width = wall_width + "px";
            document.getElementById('id_geom_map').style.height = 1024 + "px";
        }

        var map = L.map('id_geom_map', {
            minZoom: minzoom,
            maxZoom: maxzoom,
            crs: L.CRS.Simple,
            center: [0, 0],
            zoom: startzoom,
        });

        var southWest = map.unproject([0, img_dim_y], map.getMaxZoom());
        var northEast = map.unproject([img_dim_x, 0], map.getMaxZoom());
        map.setMaxBounds(new L.LatLngBounds(southWest, northEast));

        var wall_layer = L.tileLayer('{{ wall.wall_image.get_tiles_url }}/{z}/{x}/{y}.png', {
            minZoom: 1, maxZoom: maxzoom,
            noWrap: false,
            tileSize: 256,
            continuousWorld: true,
        });

        wall_layer.addTo(map);

        var otherroutes = {{ wall_routegeom_list_draw|geojsonfeature|safe }};
        var editableRoute = {{ routegeom_selected|geojsonfeature|safe }}

        oldlayer =  L.geoJson(otherroutes);
        oldlayer.addTo(map);

        newlayer = L.geoJson(editableRoute);
        newlayer.addTo(map);

        var drawControl = new L.Control.Draw({
            edit: {
                featureGroup: newlayer
            }
        });

        map.addControl(drawControl);

        var toolbar;
        for (var toolbarId in drawControl._toolbars) {
            toolbar = drawControl._toolbars[toolbarId];
            if (toolbar instanceof L.EditToolbar) {
                toolbar._modes.edit.handler.enable();
            }
        }

        map.on('mousemove', function(e) {
            var msg = JSON.stringify(newlayer.toGeoJSON());
            var cut1 = msg.match(/{"type":"LineString.+]]}/, 3);
            document.getElementById("id_geom").value = cut1[0];
        });

        map.on('draw:edited', function(e) {
            var msg = JSON.stringify(newlayer.toGeoJSON());
            var cut1 = msg.match(/{"type":"LineString.+]]}/, 3);
            document.getElementById("id_geom").value = cut1[0];
        });
    } //loadmap

    var loadevents = ["load"];
    if (loadevents.length === 0) loadmap();
    else if (window.addEventListener) for (var i=0; i<loadevents.length; i++) window.addEventListener(loadevents[i], loadmap, false);
    else if (window.jQuery) jQuery(window).on(loadevents.join(' '), loadmap);

    })();
</script>

    <form method="POST" action="{{request.path}}">

        {% csrf_token %}

        {{ routegeom_form.geom }}

        {{ route_form.non_field_errors }}
        {{ route_form.route_name.errors }}
        {{ route_form.name_of_field.errors }}

        <table width="100%">

            <tr><td>Name:</td><td>Schwierigkeit</td><td>Aktionen</td></tr>

            {% for routegeom in wall_routegeom_list %}

                {% if routegeom.pk == routegeom_selected.pk %}
                    <tr><td>
                            {{ route_form.route_name }}
                        </td><td>
                            {{ route_form.route_grade }}

                            <input type="hidden" id="id_route_wall" name="route_wall" value="{{ wall.id }}">

                        </td><td>
                            <input type="submit" value="speichern"/>

                        </td></tr>
                {% else %}
                    <tr><td>
                        {{ routegeom.route.route_name }}
                    </td><td>
                        {{ routegeom.route.route_grade }}
                    </td><td>

                        <a href="../route{{ routegeom.route.pk}}/edit"> edit </a>
                    </td></tr>
                {% endif %}
            {% endfor %}
        </table>
    </form>

{% endblock %}
