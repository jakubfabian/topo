{% extends "base.html" %}

{% block title %}
    Mitopo.de - Wall page
{% endblock %}

{% block extra_assets %}

    {% load leaflet_tags %}
    {% load geojson_tags %}
    {% leaflet_js %}
    {% leaflet_css %}

    <script type="text/javascript">
        window.onload = function () {
            map_init();
        }

        function map_init() {

            var img_dim_string = '{{ wall.get_bg_img_size }}';

            var img_dim = img_dim_string.split(',', 4);
            var img_dim_x = parseFloat(img_dim[0]);
            var img_dim_y = parseFloat(img_dim[1]);
            var xzoom = parseFloat(img_dim[2]);
            var yzoom = parseFloat(img_dim[3]);

            var maxzoom = Math.max(xzoom, yzoom);

            // we choose a default zoom level of 2 that matches either the width (approx.) or the
            // height of the container
            var minzoom = 1;
            var startzoom = 1;

            var aspectRatio = img_dim_x / img_dim_y;
            {#            if (aspectRatio < 1) {#}
            {#                // we resize the container to fit an image with aspectRatio < 1#}
            {#                // the height is then fixed to 1024px#}
            {#                var wall_width = 1024 * aspectRatio;#}
            {#                // document.getElementById('wallmap').setAttribute("style","display:block;width:500px");#}
            {#                document.getElementById('wallmap').style.width = wall_width + "px";#}
            {#                document.getElementById('wallmap').style.height = 1024 + "px";#}
            {#            }#}

            var map = L.map('wallmap', {
                minZoom: minzoom,
                maxZoom: maxzoom,
                crs: L.CRS.Simple
            });
            map.zoomControl.setPosition("topright");

            var southWest = map.unproject([0, img_dim_y], map.getMaxZoom());
             var northEast = map.unproject([img_dim_x, 0], map.getMaxZoom());
             var imBounds = new L.LatLngBounds(southWest, northEast);
             map.setMaxBounds(imBounds);
             map.fitBounds(imBounds);

            var wall_layer = L.tileLayer('{{ wall.get_tiles_url }}/{z}/{x}/{y}.png', {
                minZoom: 0, maxZoom: maxzoom,
                noWrap: false,
                tileSize: 256,
                continuousWorld: true,
            });

            wall_layer.addTo(map);

            var center_x = img_dim_x / 2;
            var center_y = img_dim_y / 2;
            var center_point = map.unproject([center_x, center_y], startzoom);

            map.setView(center_point, startzoom);

            // If there is a route list we add it to the map
            {% if wall_route_geom_list %}
             var collection = {{ wall_route_geom_list|geojsonfeature|safe }};
             layer = L.geoJson(collection);
             layer.addTo(map);
             //map.fitBounds(layer.getBounds());
            {% endif %}
        }
    </script>

{% endblock %}

{% block content %}


    <div id="wallmap"></div>

{% endblock %}

{% block mapobjects_info %}
    You're looking at wall {{ wall.name }}.
    <br/>
    {% if wallview.is_dev %}
        <a href="{% url "wall_detail" wall_id=wall.id %}">Show live wall view</a>
        <br/>
    {% endif %}

    <!-- if you are the owner or a manager -->
    <a href={% url "draw_routes" wall_id=wall.id %}>Edit {{ wall.name }}</a>




    <br><br>
    wall.wall_image.get_bg_img_size :: {{ wall.get_bg_img_size }}

    <br><br>

    {% if wall_route_geom_list %}
        In {{ wall.name }} there are following routes:
        <br>
        <br>

        <ul class="wall_route_list">
              <table style="width:100%">
                        <tr>
                            <th>name</th>
                            <th>grade</th>
                            <th>length</th>
                            <th>rating</th>
                        </tr>
            {% for routegeom in wall_route_geom_list %}
                            <tr>
                                <td><a href="{% url "route_detail" route_id=routegeom.route.pk %}">{{ routegeom.route.name }} </a></td>
                                <td>{{ routegeom.route.get_grade_display }}</td>
                                <td>{{ routegeom.route.length }}</td>
                                <td>{{ routegeom.route.rating }}</td>
                            </tr>
                        {% endfor %}
                    </table>

        </ul>
    {% else %}
        <p>Currently no routes are available in {{ wall.name }}</p>
    {% endif %}

{% endblock %}




