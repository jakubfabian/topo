{% extends "base.html" %}
{% load staticfiles %}

{% block title %}
    Mitopo.de - Spot Edit
{% endblock %}

{% block extra_assets %}

    {% load leaflet_tags %}
    {% load geojson_tags %}
    {% leaflet_js plugins="forms" %}
    {% leaflet_css plugins="forms" %}

    <script type="text/javascript">

function map_init_basic(map, options) {

    map.options.maxZoom = 15;

    var existingSpots = {{ spot_list|geojsonfeature|safe }};
    var newSpot;

    existingSpotssLayer = L.geoJson(existingSpots, {
        pointToLayer: function (feature, latlng) {
            return L.marker(latlng);
        }
    });

    markers = new L.MarkerClusterGroup();
    markers.addLayer(existingSpotsLayer);
    map.addLayer(markers);


    if(existingSpots.features.length === 0) {
        munich = new L.marker([48.137154, 11.576124]);
        map.setView(munich.getLatLng(), 10);
    } else {
        map.fitBounds(markers.getBounds().pad(0.5))
    };

    map.on('click', function (e) {
        if (newSpot === undefined) {
            newSpot = new L.marker(e.latlng).addTo(map);
        } else {
            newSpot.setLatLng(e.latlng);
        }
        var geojson = {
            "type": "Point",
            "coordinates": L.GeoJSON.latLngToCoords(e.latlng)
        };

        document.getElementById("id_geom").value = JSON.stringify(geojson);
    });

}

    </script>

    {% leaflet_map "spotmap" callback="window.map_init_basic" %}
{% endblock %}

{% block mapobjects_info %}
    <h1>Spot add</h1>

    <form method="POST" action="{% url 'spot_add' %}">
        {% csrf_token %}
        {{ form }}
        <input type="submit" value="save">
    </form>

    <form method="GET" action="{% url 'spot_add' %}">
        {% csrf_token %}
        <input type="submit" value="cancel">
    </form>

{% endblock %}
