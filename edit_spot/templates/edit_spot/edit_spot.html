{% extends "base.html" %}
{% load staticfiles %}

{% block title %}
    Mitopo.de
{% endblock %}

{% block extra_assets %}


    {% load leaflet_tags %}
    {% load geojson_tags %}
    {% leaflet_js %}
    {% leaflet_css %}


    <script type="text/javascript">
      function map_init_basic(map, options) {
          // keep a global reference to map
          // we want to override the on-click handler later
          window.map = map;
          
            map.options.maxZoom = 17;
            map.zoomControl.setPosition("topright");

            var existingSpots = {{ spot_list|geojsonfeature|safe }};

            existingSpotsLayer = L.geoJson(existingSpots, {
                pointToLayer: function (feature, latlng) {
                    return L.marker(latlng);
                }
            });

            markers = new L.MarkerClusterGroup();
            markers.addLayer(existingSpotsLayer);
            map.addLayer(markers);

            editSpotIcon = L.icon({
                iconUrl: '{% static "edit_spot/img/edit_marker_icon.png" %}',
                iconSize: [25, 41], // size of the icon
                iconAnchor: [12, 41], // point of the icon which will correspond to marker's location
                popupAnchor: [1, -34] // point from which the popup should open relative to the iconAnchor
            });
            editParkingIcon = L.icon({
                iconUrl: '{% static "edit_spot/img/edit_parking_icon.png" %}',
                iconSize: [30, 30], // size of the icon
                iconAnchor: [15, 15], // point of the icon which will correspond to marker's location
                popupAnchor: [1, -34] // point from which the popup should open relative to the iconAnchor
            });

            var editing_Spot = {{ spot|geojsonfeature|safe }};
          var editing_Parking = {{ spot|geojsonfeature:":parking_geom"|safe }};
          
          // edit and park marker are make available globally
          edit_marker = null;
          park_marker = null;
            
            editSpotLayer = L.geoJson(editing_Spot, {
                pointToLayer: function (feature, latlng) {
                    edit_marker = L.marker(latlng, {icon: editSpotIcon});
                    return edit_marker;
                }
            });

            editParkingLayer = L.geoJson(editing_Parking, {
                pointToLayer: function (feature, latlng) {
                    park_marker = L.marker(latlng, {icon: editParkingIcon});
                    return park_marker;
                }
            });

            map.addLayer(editSpotLayer);
            map.addLayer(editParkingLayer);
            if(park_marker){
                map.fitBounds([edit_marker.getLatLng(), park_marker.getLatLng()])
            }else{
                map.setView(edit_marker.getLatLng(), 15);
            }

        }

        function toggle_locate_spot(){
            if($("#parking_locate_button").hasClass('active')){
                $("#parking_locate_button").removeClass('active');
                window.map.off('click', on_parking_location);
            }

            if($("#spot_locate_button").hasClass('active')){
                $("#spot_locate_button").removeClass('active')
                window.map.off('click', on_spot_location);
            } else {
                $("#spot_locate_button").addClass('active')
                window.map.on('click', on_spot_location);
            }

        }
        function toggle_locate_parking(){
            if($("#spot_locate_button").hasClass('active')){
                $("#spot_locate_button").removeClass('active');
                window.map.off('click', on_spot_location);
            }

            if($("#parking_locate_button").hasClass('active')){
                $("#parking_locate_button").removeClass('active')
                window.map.off('click', on_parking_location);
            } else {
                $("#parking_locate_button").addClass('active')
                window.map.on('click', on_parking_location);
            }
        }
            
        
        function on_spot_location(e){
                window.edit_marker.setLatLng(e.latlng);
                var geojson = {
                    "type": "Point",
                    "coordinates": L.GeoJSON.latLngToCoords(e.latlng)
                };

                document.getElementById("id_geom").value = JSON.stringify(geojson);
        }
        
        function on_parking_location(e){
            
            if(window.park_marker){
                window.park_marker.setLatLng(e.latlng);
            }else{
                window.park_marker = L.marker(e.latlng, {icon: editParkingIcon}).addTo(window.map);
            }
            var geojson = {
                "type": "Point",
                "coordinates": L.GeoJSON.latLngToCoords(e.latlng)
            };
            
            document.getElementById("id_parking_geom").value = JSON.stringify(geojson);
        }
                            
            
        

        </script>
{% endblock %}

{% block overwrite_styles %}

    <link rel="stylesheet" href={% static "edit_spot/css/main.css" %}/>

{% endblock %}

{% block content %}
    <div class="row">

        <ul class="nav nav-tabs">
            <li class="nav-item">
                <a class="nav-link active" href="{% url "edit_spot" spot_id=spot.pk %}">Edit Spot</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{% url "add_route" spot_id=spot.pk %}">Routepool</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{% url "edit_spot_wall_index" spot_id=spot.pk %}">Choose Wall</a>
            </li>
            {% if last_wall_id %}
                <li class="nav-item">
                    <a class="nav-link" href="{% url "link_routes_to_wall" wall_id=last_wall_id %}">Link Routes to Wall</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{% url "draw_routes" wall_id=last_wall_id %}">Draw Routes on Wall</a>
                </li>
            {% endif %}&nbsp;

        </ul>
    </div>
    <div class="row full-height">
        <div class="col-md-3 white-background full-height">
            <h1>Edit Spot :: {{ spot.name }}</h1>

            <form method="POST" action="{% url "edit_spot" spot_id=spot.pk %}">
              {% csrf_token %}
              <div class="button" id="spot_locate_button" onclick="toggle_locate_spot();">Locate spot</div>
              <div class="button" id="parking_locate_button" onclick="toggle_locate_parking();" >Locate parking</div>
              <br>
              <div>
                {{ form.as_p }}
              </div>
              <input type="submit" value="save">
            </form>

            <form method="GET" action="{% url "edit_spot_index" %}">
                {% csrf_token %}
                <input type="submit" value="cancel">
            </form>
            <p>
            <form method="GET" action="{% url "add_route" spot_id=spot.pk %}">
                {% csrf_token %}
                <input type="submit" value="Add routes">
            </form>
            </p>
        </div>
        <div class="col-md-9 full-height">
            {% leaflet_map "spotmap" callback="window.map_init_basic" %}
        </div>
    </div>


{% endblock %}
