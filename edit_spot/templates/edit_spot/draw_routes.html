{% extends "base.html" %}
{% load staticfiles %}

{% block title %}
    Mitopo.de - Draw Routes on the Wall
{% endblock %}

{% block extra_assets %}
    {% load leaflet_tags %}
    {% load geojson_tags %}
    {% leaflet_js %}
    {% leaflet_css %}
    {% leaflet_js plugins="forms" %}
    {% leaflet_css plugins="forms" %}

    <style>

        #route_list .ui-selecting {
            background: #FECA40;
        }

        #route_list .ui-selected {
            background: #F39814;
            color: black;
        }
        #route_list {
            list-style-type: none;
            margin: 0;
            padding: 0;
            width: 60%; }
        
        #selectable li {
            margin: 3px;
            padding: 0.4em;
            font-size: 1.0em;
            height: 18px; }


    </style>
{% endblock %}

{% block overwrite_styles %}

    <link rel="stylesheet" href={% static "edit_spot/css/main.css" %}/>

{% endblock %}

{% block content %}
  <script>
    function map_init(mapdiv_id) {
        // Map init paperworks...
        var img_dim_string = '{{ wall.get_bg_img_size }}';
        
        var img_dim = img_dim_string.split(',', 4);
        var img_dim_x = parseFloat(img_dim[0]);
        var img_dim_y = parseFloat(img_dim[1]);
        var xzoom = parseFloat(img_dim[2]);
        var yzoom = parseFloat(img_dim[3]);

        var maxzoom = Math.max(xzoom, yzoom);

        // we choose a default zoom level of 2 that matches either the width (approx.) or the
        // height of the container
        var minzoom = 1;
        var startzoom = 1;

        // global map object
        window.map = L.map(mapdiv_id, {
            minZoom: minzoom,
            maxZoom: maxzoom,
            crs: L.CRS.Simple
        });
        map.zoomControl.setPosition("topright");

        var southWest = map.unproject([0, img_dim_y], map.getMaxZoom());
        var northEast = map.unproject([img_dim_x, 0], map.getMaxZoom());
        var imBounds = new L.LatLngBounds(southWest, northEast);
        map.setMaxBounds(imBounds);
        map.fitBounds(imBounds);

        var wall_layer = L.tileLayer('{{ wall.get_tiles_url }}/{z}/{x}/{y}.png', {
            minZoom: minzoom, maxZoom: maxzoom,
            noWrap: false,
            tileSize: 256,
            continuousWorld: true,
        });

        wall_layer.addTo(map);
        // the activeGeomId is used to denote the id of the currently edited
        // or created geometry
        window.activeGeomId = null;
        window.layerdict = {};

        // We define a empty draw control and add it to the map
        // global variable!
        window.drawControl = new L.Control.Draw({
            draw: false,
            edit: false
        });
        drawControl.setPosition("topright");
        map.addControl(drawControl);
        polylinecontrol = new L.Draw.Polyline(map, drawControl.options.polyline);

        // Now we initialize the existing route geometries
        {% if wall_routegeomlist %}
        var collection = {{ wall_routegeomlist|geojsonfeature|safe }};
        var routenames = [];
        var geomids = [];
        {% for geom in wall_routegeomlist %}
        routenames.push("{{ geom.route.name }}");
        geomids.push("{{ geom.id }}");
        {% endfor %}
        for (var i = 0; i < collection.features.length; i++) {
            if (collection.features[i].geometry) {
                var geoJsonFC = L.geoJson(collection.features[i]);
                var polyline = null;
                
                geoJsonFC.eachLayer(function (layer) {
                    polyline = L.polyline(layer.getLatLngs());
                });
                
                console.log("Creating new feature group with polyline layer with id" + geomids[i]);
                
                var featureGroup = L.featureGroup([polyline]);
                addToLayerdict(geomids[i], featureGroup);
            }
        }
        
        {% endif %}

        // map event handlers
        map.on('draw:created', function (e) {

            // we select the drawn layer and write it to the map
            var featureGroup = L.featureGroup([e.layer]);

            // this also adds the line to the map
            addToLayerdict(activeGeomId, featureGroup);

            featureGroup.eachLayer(function (layer) {
                gj = JSON.stringify(layer.toGeoJSON().geometry);
                console.log(gj);
            });


            // now we store it to the input
            // var gj_layer = e.layer.toGeoJSON();

            // we add this layer to the lookup table
            //gj = JSON.stringify(gj_layer.geometry);
            document.getElementById("geom_inputfield_" + activeGeomId).value = gj;

                    
            // remove the draw controls
            resetDrawControl();
            activeGeomId = null;
            generate_routelist();

        });

        map.on('draw:drawstop', function (e) {
            clean_handles();
        });

        map.on('draw:editstop', function (e) {
        
            //var layer = L.geoJson(e.layers.getLayers()[0].toGeoJSON());
            //var layer = e.layers.getLayers()[0];
            //var gj = JSON.stringify(layer.feature.geometry);
            //var layers = e.layers;
            var gj = null;
            var activeLayer = layerdict[activeGeomId];

            activeLayer.eachLayer(function (layer) {
                gj = JSON.stringify(layer.toGeoJSON().geometry);
                console.log(gj);
            });


            // TODO: bad hack to find activeGeomId
            document.getElementById("geom_inputfield_" + activeGeomId).value = gj;

            // remove the draw controls
            resetDrawControl();
            // activeGeomId = null;
            generate_routelist();
        
        });

        
    }
    
    function addToLayerdict(geomid, layer) {
        // Utility function to add a pair of geomid and references
        // to the layer to a dict, add the onClick handler and the layer to the map.
        layer.routegeomid = geomid;
        layerdict[geomid] = layer;
        layer.addTo(map);
        layer.on('click', on_click_polyline);
    }

    function hide_controls (elements) {
        elements = elements.length ? elements : [elements];
        for (var index = 0; index < elements.length; index++) {
            elements[index].style.display = 'none';
        }
    }

    function resetDrawControl(newDrawControl) {
        // utility function to reset the draw controls and (in case) provide
        // new draw controls
        map.removeControl(drawControl);
        if (!(newDrawControl)) {
            var newDrawControl = new L.Control.Draw({
                draw: false,
                edit: false
            });
            drawControl = newDrawControl;
            map.addControl(drawControl);
        } else {
            // we need to overwrite the global variable
            // otherwise we successively add draw controls
            drawControl = newDrawControl;
            drawControl.setPosition("topright");
            map.addControl(drawControl);
        
            hide_controls($(".leaflet-draw-toolbar"));
        }
    }


    function clean_handles(){
        if (typeof window.edittoolbarhandle !== 'undefined'){
            try{
                window.edittoolbarhandle.disable();
            }catch (err){
                // do nothing
            }
        }
        polylinecontrol.disable();
    }

    function on_edit_route (geomid, cell) {
    // disable polylinecontrol
        clean_handles();

        $(cell).children('img')
            .attr('src', "{% static "edit_spot/img/save.png" %}")
            .attr('width', '18');
        $(cell).click( function (){
            clean_handles();
        });
    

        activeGeomId = geomid;
        var activeLayer = layerdict[activeGeomId];

                        
        // Edit controls
        resetDrawControl(new L.Control.Draw({
            draw: false,
            edit: {
                featureGroup: activeLayer,
                remove: true
            }
        }));

        // in case we edit we immediately go to edit mode

        for (var toolbarId in drawControl._toolbars) {
            var toolbar = drawControl._toolbars[toolbarId];
            if (toolbar instanceof L.EditToolbar) {
                window.edittoolbarhandle = toolbar._modes.edit.handler;
                window.edittoolbarhandle.enable();
            }
        }
        // hide buttons "Save" and "Cancel". This is so dirty!
        hide_controls($(".leaflet-draw-actions"));
        
    }


    function on_click_polyline(e) {
        // Here we just use the iQuery framework to
        // select the corresponding route in the list selector
        //
        
        // Store the active geom id of the featureGroup
        activeGeomId = e.target.routegeomid;

        // Select route in routelist
        var idstring = "#rl_element_" + activeGeomId;

        // Unselect all
        var allselected = $(".ui-selected", $("#route_list"));
        allselected.not(idstring).removeClass("ui-selected").addClass("ui-unselecting");
                        
        $(idstring).addClass("ui-selecting");
        $('#route_list').data("ui-selectable")._mouseStop(null);

                        
    }



    function on_new_route (geomid) {
        activeGeomId = geomid;
        
        // Draw controls

        resetDrawControl(new L.Control.Draw({
            draw: {
                polyline: true,
                polygon: false,
                rectangle: false,
                circle: false,
                marker: false
            },
            edit: false
        }));
        // let us enable the polyline tool
        // but be careful to disable when we click somewhere else!
        // This includes events: editRoute, GeomSelect, newRoute
        // polylinecontrol = new L.Draw.Polyline(map, drawControl.options.polyline);
        polylinecontrol.enable();

    }

    function on_del_route (geomid) {
        activeGeomId = geomid;
        
        clean_handles();
        try{
            map.removeLayer(layerdict[activeGeomId]);
        }catch(err){
            console.log("Could not delete layer " + activeGeomId)
        }

        document.getElementById("geom_inputfield_" + activeGeomId).value = "None";
        generate_routelist()

    }

    function generate_routelist(){
        // generate a list of routes in the list with id #routelist
        // clear table
        $("#routetable tbody").remove();
        $("#routetable").append($('<tbody>'));
        {% for routegeom in wall_routegeomlist %}
        $("#routetable").find('tbody')
            .append($('<tr>')
                    .append($('<td>')
                            .text('{{ routegeom.route.name }}')
                           )
                    .append($('<td>')
                            .text('{{ routegeom.route.get_grade_display }}')
                           )
                    .append($('<td>')
                            .text('{{ routegeom.route.rating }}')
                           )
                    .append($('<td>'))
                    .append($('<td>'))
                   );
                
        // Check if there is a geometry string
        var geomstring = $("#geom_inputfield_{{ routegeom.id }}").val();
        
        if(geomstring == "None"){
            $("#routetable tr:last td:nth-child(4)").append($('<img>')
                                                            .attr('src', "{% static "edit_spot/img/edit.png" %}")
                                                            .attr('width', '18')
                                                            .attr('onclick', "on_new_route({{ routegeom.id }})")
                                                           );
        }else{
            var cell = $("#routetable tr:last td:nth-child(4)");
            cell.append($('<img>')
                        .attr('src', "{% static "edit_spot/img/edit-1.png" %}")
                        .attr('width', '18')
                       );
            cell.click(function() {
                on_edit_route({{ routegeom.id }}, this);
            });
            $("#routetable tr:last td:nth-child(5)").append($('<img>')
                                                            .attr('src', "{% static "edit_spot/img/garbage.png" %}")
                                                            .attr('width', '18')
                                                            .attr('onclick', "on_del_route({{ routegeom.id }})")
                                                           );
        }
        {% endfor %}
    }
    
                
    function route_selector_setup() {
        //Main entry point. All init is done here

        // route list selections
        $("#route_list").selectable({
            // on select we do something
            selected: function (event, ui) {
                // only one item can be selected!
                $(ui.selected).siblings().removeClass("ui-selected");
                $(ui.selected).addClass("ui-selected");
                // toggle mode!
                if ($(ui.selected).hasClass('click-selected')) {
                    $(ui.selected).removeClass('ui-selected click-selected');
                    clean_handles();
                    return;
                } else {
                    $(ui.selected).addClass('click-selected');

                }

                activeGeomId = $(ui.selected).val();
                var inputfield = document.getElementById("geom_inputfield_" + activeGeomId);

                var geomstring = inputfield.value;
                
                
                if (geomstring == "None") {
                    on_new_route();
                } else {
                    on_edit_route();
                }
            },
            unselected: function (event, ui) {
                $(ui.unselected).removeClass('click-selected');
                clean_handles();
            }
        });
    }


    $(document).ready(function () {
        map_init('wallmap');
        //route_selector_setup();
        generate_routelist();
    });
  </script>


    <div class="row">

        <ul class="nav nav-tabs">
            <li class="nav-item">
                <a class="nav-link" href="{% url "edit_spot" spot_id=spot.pk %}">Edit Spot</a> &nbsp;
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{% url "add_route" spot_id=spot.pk %}">Routepool</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{% url "edit_spot_wall_index" spot_id=spot.pk %}">Choose Wall</a>
            </li>
            {% if last_wall_id %}
                <li class="nav-item">
                    <a class="nav-link" href="{% url "link_routes_to_wall" wall_id=last_wall_id %}">Link Routes to
                        Wall</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="{% url "draw_routes" wall_id=last_wall_id %}">Draw Routes on
                        Wall</a>
                </li>
            {% else %}
                <li class="nav-item">
                    <a class="nav-link disabled" href="#">Link Routes to Wall</a>
                </li>
            {% endif %}&nbsp;

        </ul>
    </div>
    <div class="row full-height">

        <div class="col-lg-9 col-lg-push-3 full-height">
            <div id="wallmap" class="full-height"></div>

            <script type="text/javascript">

              
              // The leaflet part

              function annotateGeom(layer, geomRouteName) {
                        // here we want to add popups below the route geometries with
                        // the route names as labels

                        /* var firstPoint = layer._layers._latlngs[0];
                         var lastPoint = layer._layers._latlngs[-1];

                         which one is below the other?
                         if(firstPoint[lat] < lastPoint[lat]){
                         var annotPoint = firstPoint;
                         }
                         else{
                         var annotPoint = lastPoint;
                         }

                         var popup = L.popup()
                         .setLatLng(annotPoint)
                         .setContent(geomRouteName)
                         .openOn(map);*/
              }



              </script>

        </div>
        <div class="col-lg-3 col-lg-pull-9 white-background full-height">
            Dude, You're looking at wall {{ wall.name }}
            <br><br>
            <!-- css styles for the selectable list. TODO: put tags in css files -->
            <!-- We populate the list of routes on the spot. TODO: Generate this list dynamically and sort it by wall name -->
            <a href="{% url "wall_detail" wall_id=wall.pk %}">Show live wall</a>
            <br><br>

            <div id="routelist_div">
              route list (click to edit):
              <br>
              <table id="routetable" style="width:100%">
                <thead>
                  <tr>
                    <th>name</th>
                    <th>grade</th>
                    <th>rating</th>
                    <th></th>
                    <th></th>
                  </tr>
                </thead>
                <tbody>
                </tbody>
              </table>
                      
              <button onclick="generate_routelist()">Generate Routelist</button>
            </div>

            <!-- The form redirects to the original url. The route_chooser dif is populated by hidden input elements -->
            <form method="POST" action="{{ request.path|urlencode }}">
                {% csrf_token %}
                
                {% for routegeom in wall_routegeomlist %}
                  <input id="geom_inputfield_{{ routegeom.id }}" type="hidden"
                         name="routegeomid_{{ routegeom.id }}"
                         value="{{ routegeom.geom }}">                
                {% endfor %}
                <input type="submit" value="speichern"/>
            </form>

            <form method="GET" action="{% url 'publish_wall' wall_id=wall.pk %}">
                {% csrf_token %}
                <input type="submit" value="publish wall">
            </form>
        </div>
    </div>


{% endblock %}

