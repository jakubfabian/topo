{% extends "base.html" %}
{% load staticfiles %}
{% load leaflet_tags %}
{% load geojson_tags %}

{% block title %}
  
    Mitopo.de - {{ editing|yesno:"Edit wall, Add new Wall" }} {{ wall.name }}
{% endblock %}

{% block extra_assets %}
    <link rel="stylesheet" href={% static "edit_spot/css/main.css" %}/>
    {% include "leaflet_base.html" %}

    <script type="text/javascript">

function map_init_basic(map, options) {
    map.zoomControl.setPosition("topright");

    map.options.maxZoom = 17;

    var existingwalls = {{ wall_list|geojsonfeature|safe }};
    existingwallsLayer = L.geoJson(existingwalls, {
        pointToLayer: function (feature, latlng) {
            return L.marker(latlng, {icon: LeafletWallIcon});
        }
    });

    markers = new L.MarkerClusterGroup();
    markers.addLayer(existingwallsLayer);


    {% if editing %}
    var editing_wall = {{ wall|geojsonfeature|safe }};

    editing_wall_layer = L.geoJson(editing_wall, {
        pointToLayer: function (feature, latlng) {
            newwall = L.marker(latlng, {icon: LeafletEditWallIcon});
            return newwall;
        }
    });
    markers.addLayer(editing_wall_layer);
    {% endif %}

    map.addLayer(markers);

    
    if(existingwalls.features.length === 0) {
        var editing_Spot = {{ spot|geojsonfeature|safe }};
        var edit_marker;
        editSpotLayer = L.geoJson(editing_Spot, {
            pointToLayer: function (feature, latlng) {
                edit_marker = L.marker(latlng, {icon: LeafletWallIcon});
                return edit_marker;
            }
        });
        map.setView(edit_marker.getLatLng(), 15);
    } else {
        map.fitBounds(markers.getBounds().pad(0.5))
    };

    map.on('click', function (e) {
        if (typeof newwall == "undefined") {
            newwall = new L.marker(e.latlng, {icon: LeafletEditWallIcon}).addTo(map);
        } else {
            newwall.setLatLng(e.latlng);
        }
        var geojson = {
            "type": "Point",
            "coordinates": L.GeoJSON.latLngToCoords(e.latlng)
        };

        document.getElementById("id_geom").value = JSON.stringify(geojson);
    });

}

    </script>

{% endblock %}


{% block content %}

{% include "edit_spot/edit_pane.html" %}

<div class="row full-height">
    <div class="col-md-3 full-height white-background">

        <h1>{{ editing|yesno:"Edit wall, Add new Wall" }} {{ wall.name }}</h1>

        <form method="POST" enctype="multipart/form-data" >
            {% csrf_token %}
            {{ form.as_p }}
            <button type="submit" class="btn btn-info btn-xs">
                <span class="glyphicon glyphicon-floppy-save"></span> Save
            </button>
            <a href="{% url 'edit_spot_wall_index' spot_id=spot.pk %}"
                class="btn btn-info btn-xs" role="button">
                <span class="glyphicon glyphicon-remove"></span>
            </a>
        </form>
        </form>


    </div>
    <div class="col-md-9 full-height">

        {% leaflet_map "wallmap" callback="window.map_init_basic" %}

    </div>
</div>

{% endblock %}
